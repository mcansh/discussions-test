"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.findMatchingEntries = void 0;
const tslib_1 = require("tslib");
const path_1 = (0, tslib_1.__importDefault)(require("path"));
const tar_stream_1 = (0, tslib_1.__importDefault)(require("tar-stream"));
const buffer_from_stream_1 = require("./buffer-from-stream");
async function findMatchingEntries(stream, dirname, onEntry) {
    stream
        .pipe(tar_stream_1.default.extract())
        .on("error", console.error)
        .on("entry", async (header, stream, next) => {
        let entry = {
            path: header.name.replace(/^[^/]+\/?/, "/"),
            type: header.type,
        };
        if (entry.type !== "file" ||
            !path_1.default.dirname(entry.path).startsWith(dirname)) {
            stream.resume();
            stream.on("end", next);
            return;
        }
        try {
            let content = await (0, buffer_from_stream_1.bufferStream)(stream);
            entry.content = content.toString("utf8");
            await onEntry(entry);
            next();
        }
        catch (error) {
            next(error);
        }
    });
}
exports.findMatchingEntries = findMatchingEntries;
